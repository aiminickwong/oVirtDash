<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<link href="bower_components/bootstrap/dist/css/bootstrap.css" rel="stylesheet">
  		<link href="index.css" rel="stylesheet">

		<script src="bower_components/jquery/dist/jquery.js"></script>
		<script src="bower_components/bootstrap/dist/js/bootstrap.js"></script>
  		<script src="bower_components/react/react.js"></script>		
  		<script src="bower_components/react-bootstrap/react-bootstrap.js"></script>
  		<script src="ovirt.js"></script>
		<script src="cookies.js"></script>

	</head>
	<body>
		
	</body>

	<script>
		var username = docCookies.getItem("username");
		var password = docCookies.getItem("password");
		var enginehost = docCookies.getItem("enginehost");

		if(!username || !password || !enginehost){
			window.location = "login.html";
		}

		var apiurl = "http://" + enginehost + "/ovirt-engine/api";

		var parseStatistics = function(xml) {

	        var xmlDoc= $.parseXML(xml);

	        var product_info = xmlDoc.getElementsByTagName("product_info")[0];

	        var summary = xmlDoc.getElementsByTagName("summary")[0];
	        var vms = summary.getElementsByTagName("vms")[0];
	        var time = xmlDoc.getElementsByTagName("time")[0];

	        var objStatistics = {
	            product_info: {
	                name: product_info.getElementsByTagName("name")[0].textContent,
	                vendor: product_info.getElementsByTagName("vendor")[0].textContent,
	                full_version: product_info.getElementsByTagName("full_version")[0].textContent
	    	    },

	            summary: {
	                vms: {
	                    total: parseInt(vms.getElementsByTagName("total")[0].textContent),
	                    active: parseInt(vms.getElementsByTagName("active")[0].textContent)
	                },
	            },

	            time: time.textContent
	        };

	        return objStatistics;
	    }	

	    var parseDatacenters = function(xml){
	        var xmlDoc= $.parseXML(xml);

	        var data_centers = xmlDoc.getElementsByTagName("data_center");
	        
	        var objDatacenters = [];

	        for(var i = 0; i < data_centers.length; i++){
	            var objDatacenter = {
	                name: data_centers[i].getElementsByTagName("name")[0].textContent,
	                status: data_centers[i].getElementsByTagName("status")[0].textContent
	            };
	            objDatacenters.push(objDatacenter);
	        };
	        
	        return objDatacenters;
    	}

    	var parseNetworks = function(xml){
	        var xmlDoc= $.parseXML(xml);

	        var networks = xmlDoc.getElementsByTagName("networks");
	        
	        var objNetworks = [];

	        for(var i = 0; i < networks.length; i++){
	            var objNetworks = {
	                name: networks[i].getElementsByTagName("name")[0].textContent,
	                description: networks[i].getElementsByTagName("status")[0].textContent,
	                usage: networks[i].getElementsByTagName("usages")[0].getElementsByTagName("usage")
	            };
	            objNetworks.push(objNetworks);
	        };
	        
	        return objNetworks;
    	}

		var statisticsComponent = React.createClass({
			render: function (){
				return React.createElement("div", null,
					React.createElement("h1", null, "Statistics"), 
					React.createElement(ReactBootstrap.Panel, {
							header: "Product information"
						},
						React.createElement("div", null, "Name: " + this.props.data.product_info.name),
						React.createElement("br", null),
						React.createElement("div", null, "Vendor: " + this.props.data.product_info.vendor),
						React.createElement("br", null),
						React.createElement("div", null, "Version: " + this.props.data.product_info.full_version)
					),

					React.createElement(ReactBootstrap.Panel, {
							header: "Summary"
						},
						React.createElement("div", null, "Total VMs: " + this.props.data.summary.vms.total),
						React.createElement("br", null),
						React.createElement("div", null, "Active VMs: " + this.props.data.summary.vms.active)
					),

					React.createElement("div", null, "Time: " + this.props.data.time)
				);
			}
		})

		var datacenterComponent = React.createClass({
			render: function() {
				var panelElems = [];
				for(var i = 0; i < this.props.data.length; i++){
					panelElems.push(React.createElement(ReactBootstrap.Panel,{
						header: this.props.data[i].name
					}, this.props.data[i].status));
				}

				return React.createElement("div", null, 
					React.createElement("h1", null, "Available Datacenters"), 
					panelElems
				);
			}
		})

		var navbarComponent =  React.createClass({
			render: function(){
				var self = this;
				return React.createElement(ReactBootstrap.Navbar, {
						brand: React.createElement("img", {
							src: "images/ovirt.png"
						})
					}, 
					React.createElement(ReactBootstrap.Nav, {
						onSelect: function(eventKey){
							self.props.onView(eventKey);
						}
					},

						React.createElement(ReactBootstrap.NavItem, {
							eventKey:"statistics",
							href: "#"
						}, "Statistics"),

						React.createElement(ReactBootstrap.NavItem, {
							eventKey: "datacenters",
							href: "#"
						}, "Datacenters"),

						React.createElement(ReactBootstrap.NavItem, {
							eventKey: "storage",
							href: "#"
						}, "Storage"),

						React.createElement(ReactBootstrap.NavItem, {
							eventKey: "networks",
							href: "#"
						}, "Networks"),

						React.createElement(ReactBootstrap.NavItem, {
							eventKey: "clusters",
							href: "#"
						}, "Clusters")
					),

					React.createElement("form", {
						className:"navbar-form pull-right"
					}, React.createElement("button", {
						type: "submit",
						className: "btn btn-success",
						onClick: function(ev){
							alert("hi");
							window.location = "login.html"

							ev.preventDefault();
						}
					}, "Sign out"))
				);
			}
		})

		var rootComponent = React.createClass({
			getInitialState: function(){
				return {
					loading: {
						statistics: false,
						datacenters: false,
						storage: false,
						networks: false,
						clusters: false
					},	
					view: "statistics",
					data: {
						statistics: null,
						datacenters: null,
						storage: null,
						networks: null,
						clusters: null,
						error: null
					}
				}
			},

			getStatisticsData: function(){
				if(this.state.loading.statistics){
					return; //statistics already loading so no need to get data again
				}

				var self = this;
				$.ajax({
			        url: apiurl,
			        type: "GET",
			        dataType: "text",
			        username: username,
			        password: password,

			        success: function(data){
			            var statistics = parseStatistics(data);
			            var state = self.state;
			            state.loading.statistics = false;
			            state.data.statistics = statistics;
			            self.setState(state);
			        },

			        error: function(err){
			        	var state = self.state;
			        	state.data.error = {
			        		message: err.statusText
			        	}
			        	state.view = "error";
			        	self.setState(state);
			        }
    			});

				setTimeout(function() {
					var state =  self.state;
					state.loading.statistics = true;
					self.setState(state);
				}, 0);
			},

			getDatacenterData: function(){
				var self = this;

				$.ajax({
					url: apiurl + "/datacenters",
					type: "GET",
					dataType: "text",
					username: username,
					password: password,

					success: function(xml){
			            var datacenters = parseDatacenters(xml);
			            var state = self.state;
			            state.loading.datacenters = false;
			            state.data.datacenters = datacenters;
			            self.setState(state);
					},

					error: function(err){
						var state = self.state;
			        	state.data.error = {
			        		message: err.statusText
			        	}
			        	state.view = "error";
			        	self.setState(state);
					}
				}); 
				setTimeout(function() {
					var state =  self.state;
					state.loading.datacenters = true;
					self.setState(state);
				}, 0)
			},

			getNetworksData: function(){
				var self = this;

				$.ajax({
					url: apiurl + "/networks",
					type: "GET",
					dataType: "text",
					username: username,
					password: password,

					success: function(xml){
			            var networks = parseNetworks(xml);
			            var state = self.state;
			            state.loading.networks = false;
			            state.data.networks = networks;
			            self.setState(state);
					},

					error: function(err){
						var state = self.state;
			        	state.data.error = {
			        		message: err.statusText
			        	}
			        	state.view = "error";
			        	self.setState(state);
					}
				}); 
				setTimeout(function() {
					var state =  self.state;
					state.loading.networks = true;
					self.setState(state);
				}, 0)
			},

			changeView: function(view){
				var state = this.state;
				state.view = view;
				this.setState(state);
			},

			render: function(){
				var navElement = React.createElement(navbarComponent, {
					onView: this.changeView
				});
	
				var waitingElement = React.createElement("div", null, 
					navElement,
					React.createElement("div", {className: "container"}, 
						React.createElement("h1", null, 
							React.createElement("span", {
								className:"glyphicon glyphicon-refresh glyphicon-refresh-animate"
							}), " Loading..."
						)
					)
				);

				if(this.state.view === "datacenters"){
					if(this.state.loading.datacenters){
						return waitingElement;
					}

					if(this.state.data.datacenters){
						return React.createElement("div", null, 
							navElement,
							React.createElement("div", 
								{
									className: "container"
								}, 
								React.createElement(datacenterComponent, {
									data: this.state.data.datacenters
								})
							)
						);
					}
					else {
						this.getDatacenterData();
					}
				}			

				if(this.state.view === "statistics"){
					if(this.state.loading.statistics){
						return waitingElement;
					}

					if(this.state.data.statistics){
						return React.createElement("div", null, 
							navElement,
							React.createElement("div", {
									className: "container"
								}, 
								React.createElement(statisticsComponent, {
									data: this.state.data.statistics
								})
							)
						);
					}

					else{
						this.getStatisticsData();
					}
				}

				if(this.state.view === "error"){
					return React.createElement("div", null, 
						navElement,
						React.createElement("h1", null, "error: " + this.state.data.error.message)
					);
				}

				return React.createElement("div", null, 
					navElement
				);
			}
		})

		React.render(React.createElement(rootComponent, null), document.body);
	</script>
</html>